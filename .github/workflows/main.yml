name: Clean All Player Branches

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  clean_branches:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branches:
          - Player_S4me
          - Player_Mandrakodi
          - Player_Wltv
          - Player_Thegroove
          - Player_Torrent
          - Player_Scrubsv2
    steps:
      - name: Checkout branch (${{ matrix.branches }})
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branches }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Sync from main
        run: |
          git fetch origin main
          git merge origin/main --no-edit --allow-unrelated-histories || echo "Merge fallito, procedo comunque"

      - name: Clean branch files
        run: |
          case "${{ matrix.branches }}" in
            *S4me*)
              KEEP_PATTERN="S4Me_player_|S4me_"
              find . -type f -name "*.json" | grep -E "$KEEP_PATTERN" > files_to_keep.txt
              find . -type f -name "*.json" | grep -vE "$KEEP_PATTERN" | xargs rm -f
              ;;
            *Mandrakodi*)
              KEEP_PATTERN="MK_player_"
              find . -type f -name "*.json" | grep -E "$KEEP_PATTERN" > files_to_keep.txt
              find . -type f -name "*.json" | grep -vE "$KEEP_PATTERN" | xargs rm -f
              ;;
            *Wltv*)
              KEEP_PATTERN="WLTV"
              find . -type f -name "*.json" | grep -E "$KEEP_PATTERN" > files_to_keep.txt
              find . -type f -name "*.json" | grep -vE "$KEEP_PATTERN" | xargs rm -f
              ;;
            *Thegroove*)
              KEEP_PATTERN="TG360_player_"
              find . -type f -name "*.json" | grep -E "$KEEP_PATTERN" > files_to_keep.txt
              find . -type f -name "*.json" | grep -vE "$KEEP_PATTERN" | xargs rm -f
              ;;
            *Torrent*)
              KEEP_PATTERN="elementum"
              find . -type f -name "*.json" | grep -E "$KEEP_PATTERN" > files_to_keep.txt
              find . -type f -name "*.json" | grep -vE "$KEEP_PATTERN" | xargs rm -f
              ;;
            *Scrubsv2*)
              # Fix specifico per Scrubs - cerca esattamente direct.scrubsv2.json
              find . -type f -name "direct.scrubsv2.json" > files_to_keep.txt
              find . -type f -name "*.json" -not -name "direct.scrubsv2.json" | xargs rm -f
              ;;
          esac

          # Mantieni sempre la cartella .github
          find . -type d -not -name ".github" -not -path "." -empty -delete 2>/dev/null || true

      - name: Commit and push changes
        run: |
          git add .
          git commit -m "ðŸ”„ Auto-clean: mantengo solo file del player" --allow-empty || echo "Nessun cambiamento"
          git push origin ${{ matrix.branches }} || echo "Push fallito"
